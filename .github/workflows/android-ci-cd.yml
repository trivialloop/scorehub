name: "Android CI/CD"

on:
  push:
    branches: [ "main" ]
    # paths:
    #   - 'app/**'
    #   - 'gradle/**'
    #   - '*.gradle'
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    name: "Run Tests"
    runs-on: ubuntu-latest
    
    steps:
      - name: "Checkout code"
        uses: actions/checkout@v6
      
      - name: "Set up JDK 21"
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
      
      - name: "Setup Gradle"
        uses: gradle/actions/setup-gradle@v5
        
      - name: "Run unit tests"
        run: ./gradlew testFossDebugUnitTest
      
      - name: "Upload unit test reports"
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: unit-test-reports
          path: app/build/reports/tests/
      
      - name: "Run lint"
        run: ./gradlew lintFossDebug
      
      - name: "Upload lint reports"
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: lint-reports
          path: app/build/reports/lint-results-debug.html

      #TODO Add check to validate app version

  build:
    name: "Build APK"
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: "Checkout code"
        uses: actions/checkout@v6
      
      - name: "Set up JDK 21"
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
      
      - name: "Setup Gradle"
        uses: gradle/actions/setup-gradle@v5
      
      - name: "Build debug APK"
        run: ./gradlew assembleDebug --stacktrace
      
      - name: "Upload debug APK"
        uses: actions/upload-artifact@v6
        with:
          name: app-debug
          path: |
            app/build/outputs/apk/foss/debug/*.apk
            app/build/outputs/apk/foss/debug/*.json
      
      - name: "Build release APK"
        if: github.ref == 'refs/heads/main'
        run: ./gradlew assembleRelease --stacktrace
      
      - name: "Upload release APK"
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v6
        with:
          name: app-release
          path: |
            app/build/outputs/apk/foss/release/*.apk
            app/build/outputs/apk/foss/release/*.json

  release:
    name: "Create GitHub Release"
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: "Checkout code"
        uses: actions/checkout@v6
      
      - name: "Set up JDK 21"
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
      
      - name: "Setup Gradle"
        uses: gradle/actions/setup-gradle@v5
      
      - name: "Download Artifacts"
        uses: actions/download-artifact@v7
        with:
          name: app-release
          path: artifacts
      
      - name: "Get Version Name"
        id: get_version
        run: |
          # Install jq if not present
          if ! command -v jq &> /dev/null; then
            apt-get update
            apt-get install -y jq
          fi
          VERSION_CODE=$(jq -r '.elements[0].versionCode' "artifacts/output-metadata.json")
          VERSION_NAME=$(jq -r '.elements[0].versionName' "artifacts/output-metadata.json")
          echo "version_code=${VERSION_CODE}" >> ${GITHUB_OUTPUT}
          echo "version_name=v${VERSION_NAME}" >> ${GITHUB_OUTPUT}
      
      - name: "Create GitHub Release"
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_version.outputs.version_name }}
          body_path: fastlane/metadata/android/en-US/changelogs/${{ steps.get_version.outputs.version_code }}.txt
          files: |
            artifacts/*.apk
          token: ${{ secrets.RELEASE_GITHUB_TOKEN }}
          generate_release_notes: true
          draft: true
          prerelease: false
